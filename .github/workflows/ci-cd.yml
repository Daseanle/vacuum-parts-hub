# 24å°æ—¶è‡ªåŠ¨åŒ–éƒ¨ç½²å·¥ä½œæµé…ç½®
# Vacuum Parts Hub - CI/CD Pipeline
# åŠŸèƒ½ï¼šä»£ç æ¨é€æ—¶è‡ªåŠ¨æ„å»ºã€æµ‹è¯•ã€éƒ¨ç½²

name: Auto-Deploy Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  # å®šæ—¶å¥åº·æ£€æŸ¥ï¼ˆæ¯å¤©å‡Œæ™¨2ç‚¹ï¼‰
  schedule:
    - cron: '0 2 * * *'
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

# è®¾ç½®æƒé™ä»¥å…è®¸éƒ¨ç½²
permissions:
  contents: read
  pages: write
  id-token: write

# å¹¶å‘æ§åˆ¶
concurrency:
  group: "pages"
  cancel-in-progress: false

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '8'

jobs:
  # ============================================
  # Job 1: ä»£ç è´¨é‡æ£€æŸ¥å’Œæµ‹è¯•
  # ============================================
  quality-check:
    name: ğŸ” ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸŸ¢ è®¾ç½® Node.js ç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: npm ci

      - name: ğŸ” ESLint ä»£ç æ£€æŸ¥
        run: npm run lint
        continue-on-error: false

      - name: ğŸ—ï¸ æ„å»ºæ£€æŸ¥
        run: npm run build
        env:
          NEXT_TELEMETRY_DISABLED: 1

      - name: ğŸ“Š æ„å»ºåˆ†æ
        run: |
          echo "ğŸ“Š æ„å»ºç»Ÿè®¡:"
          du -sh .next
          ls -lh .next/static

  # ============================================
  # Job 2: å®‰å…¨æ‰«æ
  # ============================================
  security-scan:
    name: ğŸ”’ å®‰å…¨ä¾èµ–æ‰«æ
    runs-on: ubuntu-latest
    needs: quality-check
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸŸ¢ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: npm ci

      - name: ğŸ” è¿è¡Œå®‰å…¨å®¡è®¡
        run: npm audit --audit-level=moderate
        continue-on-error: true

      - name: ğŸ“ˆ ç”Ÿæˆå®‰å…¨æŠ¥å‘Š
        if: always()
        run: |
          echo "âœ… å®‰å…¨æ‰«æå®Œæˆ"
          echo "æ‰«ææ—¶é—´: $(date)" > security-report.txt

  # ============================================
  # Job 3: éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
  # ============================================
  deploy:
    name: ğŸš€ éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
    runs-on: ubuntu-latest
    needs: [quality-check, security-scan]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: production
      url: ${{ steps.deploy.outputs.url }}
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸŸ¢ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: npm ci

      - name: ğŸ—ï¸ æ„å»ºç”Ÿäº§ç‰ˆæœ¬
        run: |
          npm run build
          echo "âœ… æ„å»ºå®Œæˆ"
        env:
          NEXT_TELEMETRY_DISABLED: 1
          NODE_ENV: production

      - name: ğŸ“ éƒ¨ç½²åˆ° Vercel
        id: deploy
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'
          working-directory: ./

      - name: âœ… éƒ¨ç½²æˆåŠŸé€šçŸ¥
        if: success()
        run: |
          echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
          echo "é¢„è§ˆ URL: ${{ steps.deploy.outputs.preview-url }}"

      - name: âŒ éƒ¨ç½²å¤±è´¥é€šçŸ¥
        if: failure()
        run: |
          echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
          exit 1

  # ============================================
  # Job 4: å¥åº·æ£€æŸ¥
  # ============================================
  health-check:
    name: ğŸ’“ å¥åº·æ£€æŸ¥
    runs-on: ubuntu-latest
    needs: deploy
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: â³ ç­‰å¾…éƒ¨ç½²å®Œæˆ
        run: sleep 60

      - name: ğŸ” æ£€æŸ¥ç½‘ç«™å¯è®¿é—®æ€§
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" https://vacuumpartshub.com)
          if [ $response -eq 200 ]; then
            echo "âœ… ç½‘ç«™è¿è¡Œæ­£å¸¸ (HTTP $response)"
          else
            echo "âŒ ç½‘ç«™å¼‚å¸¸ (HTTP $response)"
            exit 1
          fi

      - name: ğŸ“Š æ€§èƒ½æ£€æŸ¥
        run: |
          time=$(curl -s -o /dev/null -w "%{time_total}" https://vacuumpartshub.com)
          echo "âš¡ å“åº”æ—¶é—´: ${time}s"
          if (( $(echo "$time > 3" | bc -l) )); then
            echo "âš ï¸ å“åº”æ—¶é—´è¿‡é•¿"
          fi

  # ============================================
  # Job 5: åˆ›å»ºéƒ¨ç½²å›æ»šï¼ˆå¤±è´¥æ—¶ï¼‰
  # ============================================
  rollback:
    name: ğŸ”„ ç´§æ€¥å›æ»š
    runs-on: ubuntu-latest
    needs: [deploy, health-check]
    if: failure()
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”„ å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬
        run: |
          git log --oneline -5
          echo "âš ï¸ æ£€æµ‹åˆ°éƒ¨ç½²å¤±è´¥ï¼Œå‡†å¤‡å›æ»š..."

      - name: ğŸš¨ å‘é€å‘Šè­¦
        run: |
          echo "ğŸš¨ éƒ¨ç½²å¤±è´¥ï¼Œå·²è§¦å‘å›æ»šæµç¨‹"
          echo "è¯·æ£€æŸ¥ GitHub Actions æ—¥å¿—"
